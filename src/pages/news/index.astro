---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/common/Header.astro';
import Footer from '../../components/common/Footer.astro';
import { getCollection } from 'astro:content';

// 1. å–å¾—æ‰€æœ‰æ¶ˆæ¯
const allNews = await getCollection('news');

// 2. æ’åºé‚è¼¯ï¼šç½®é ‚å„ªå…ˆ -> æ—¥æœŸæ–°åˆ°èˆŠ
const sortedNews = allNews.sort((a, b) => {
  if (a.data.isPinned && !b.data.isPinned) return -1;
  if (!a.data.isPinned && b.data.isPinned) return 1;
  return b.data.date.valueOf() - a.data.date.valueOf();
});

// 3. æå–æ‰€æœ‰åˆ†é¡ (ç”¨æ–¼ç¯©é¸å™¨)
// æˆ‘å€‘æ‰‹å‹•å®šç¾©é †åºï¼Œæ¯”è¼ƒç¾è§€ï¼Œè€Œä¸æ˜¯ç”¨ Set è‡ªå‹•æŠ“
const categories = [
  { id: 'all', label: 'å…¨éƒ¨æ¶ˆæ¯' },
  { id: 'announcement', label: 'è¨ºæ‰€å…¬å‘Š' },
  { id: 'closed', label: 'åœè¨ºé€šçŸ¥' },
  { id: 'activity', label: 'æ´»å‹•å¿«è¨Š' },
];

// åˆ†é¡æ¨£å¼å°ç…§è¡¨
const categoryStyle: Record<string, string> = {
  announcement: 'bg-green-50 text-green-600 border-green-100',
  closed: 'bg-red-50 text-red-600 border-red-100',
  activity: 'bg-amber-50 text-amber-600 border-amber-100',
};

function formatDate(date: Date) {
  return new Date(date).toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// ç°¡å–®çš„æ‘˜è¦æ“·å–å‡½å¼ (å»é™¤ Markdown ç¬¦è™Ÿ)
function getExcerpt(body: string) {
  return body
    .replace(/[#*`]/g, '') // å»é™¤ Markdown ç¬¦è™Ÿ
    .substring(0, 80) + '...'; // å–å‰ 80 å­—
}
---

<Layout 
  title="æœ€æ–°æ¶ˆæ¯ | Dr. Chou æ³Œå°¿ç§‘è¨ºæ‰€"
  description="éš¨æ™‚æŒæ¡è¨ºæ‰€çš„æœ€æ–°å‹•æ…‹ã€é–€è¨ºç•°å‹•èˆ‡è¡›æ•™æ´»å‹•è³‡è¨Šã€‚"
>
  
  <Header slot="header" />

  {/* === 1. Page Header (ç§»æ¤è‡ª Blog) === */}
  <section class="py-16 bg-bg relative overflow-hidden">
    {/* è£é£¾èƒŒæ™¯ */}
    <div class="absolute top-0 right-0 w-1/3 h-full bg-highlight/30 -skew-x-12 translate-x-20 z-0 pointer-events-none"></div>
    
    <div class="container mx-auto px-6 relative z-10 text-center">
      <h1 class="text-4xl md:text-5xl font-serif font-bold text-primary mb-4">æœ€æ–°æ¶ˆæ¯</h1>
      <p class="text-text max-w-2xl mx-auto leading-relaxed">
        éš¨æ™‚æŒæ¡è¨ºæ‰€çš„æœ€æ–°å‹•æ…‹ã€‚<br/>
        åŒ…å«é–€è¨ºç•°å‹•ã€ä¼‘è¨ºå…¬å‘Šèˆ‡æœ€æ–°çš„è¡›æ•™æ´»å‹•è³‡è¨Šã€‚
      </p>
    </div>
  </section>

  {/* === 2. Filter & List === */}
  <section class="py-12 bg-surface min-h-screen">
    <div class="container mx-auto px-4 md:px-6 max-w-4xl">
      
      {/* åˆ†é¡ç¯©é¸å™¨ */}
      <div class="flex flex-wrap justify-center gap-3 mb-12">
        {categories.map(cat => (
          <button 
            class={`filter-btn px-5 py-2 rounded-full text-sm font-bold transition-all border 
              ${cat.id === 'all' 
                ? 'bg-primary text-white border-transparent shadow-md active' 
                : 'bg-white text-text border-highlight shadow-sm'
              }`}
            data-filter={cat.id}
          >
            {cat.label}
          </button>
        ))}
      </div>

      {/* æ¢åˆ—å¼æ–‡ç« åˆ—è¡¨ */}
      <div class="space-y-4" id="news-list">
        {sortedNews.map((item) => {
          const catStyle = categoryStyle[item.data.category] || 'bg-gray-50 text-gray-600';
          const catLabel = categories.find(c => c.id === item.data.category)?.label || 'å…¬å‘Š';

          return (
            <a 
              href={`/news/${item.id}`}
              class="news-item group block bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md hover:border-accent/30 transition-all duration-300 relative overflow-hidden"
              data-category={item.data.category}
            >
              {/* ç½®é ‚æ¨™ç±¤ (å³å´èƒŒæ™¯è£é£¾) */}
              {item.data.isPinned && (
                <div class="absolute top-0 right-0 p-3">
                  <span class="inline-flex items-center gap-1 text-xs font-bold text-accent bg-accent/10 px-2 py-1 rounded-md">
                    <i class="fa-solid fa-thumbtack"></i> ç½®é ‚
                  </span>
                </div>
              )}

              <div class="flex flex-col md:flex-row md:items-start gap-4">
                
                {/* å·¦å´ï¼šæ—¥æœŸèˆ‡åˆ†é¡ */}
                <div class="flex flex-row md:flex-col items-center md:items-start gap-3 md:gap-2 min-w-[120px] shrink-0">
                  {/* åˆ†é¡æ¨™ç±¤ */}
                  <span class={`px-3 py-1 rounded-full text-xs font-bold border ${catStyle}`}>
                    {catLabel}
                  </span>
                  {/* æ—¥æœŸ */}
                  <span class="text-sm text-gray-400 font-medium">
                    {formatDate(item.data.date)}
                  </span>
                </div>

                {/* å³å´ï¼šæ¨™é¡Œèˆ‡æ‘˜è¦ */}
                <div class="flex-grow pr-8">
                  <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-2 group-hover:text-primary transition-colors flex items-center gap-2">
                    {item.data.title}
                    <i class="fa-solid fa-arrow-right opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all text-accent text-sm"></i>
                  </h2>
                  <p class="text-gray-600 text-sm line-clamp-2 md:line-clamp-1 group-hover:text-gray-700">
                    {getExcerpt(item.body || '')}
                  </p>
                </div>

              </div>
            </a>
          );
        })}
      </div>

      {/* ç„¡è³‡æ–™æç¤º */}
      <div id="no-results" class="hidden text-center py-20 bg-white rounded-xl border border-dashed border-gray-200 mt-8">
        <div class="text-4xl mb-4 text-gray-300">ğŸ“­</div>
        <p class="text-gray-500">æ­¤åˆ†é¡ç›®å‰æ²’æœ‰ç›¸é—œæ¶ˆæ¯ã€‚</p>
      </div>

    </div>
  </section>

  <Footer slot="footer" />

</Layout>

<style>
  /* ç¯©é¸æŒ‰éˆ•æ‡¸åœæ•ˆæœ (æ¯”ç…§å½±ç‰‡é ) */
  .filter-btn:not(.active):hover {
    @apply border-accent text-accent -translate-y-0.5 shadow-lg;
  }
  
  /* é¸ä¸­ç‹€æ…‹ hover æ™‚ä¸é¡¯ç¤º accent è‰²ï¼Œä¹Ÿä¸ä½ç§» */
  .filter-btn.active:hover {
    @apply transform-none text-white border-transparent cursor-default shadow-md;
  }
</style>

<script>
  // å‰ç«¯ç¯©é¸é‚è¼¯ (èˆ‡ Blog é¡ä¼¼ï¼Œä½†ç°¡åŒ–é)
  document.addEventListener('astro:page-load', () => {
    const buttons = document.querySelectorAll('.filter-btn');
    const items = document.querySelectorAll('.news-item');
    const noResults = document.getElementById('no-results');

    if (!buttons.length) return;

    buttons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        if (target.classList.contains('active')) return;

        // 1. æŒ‰éˆ•æ¨£å¼åˆ‡æ›
        buttons.forEach(b => {
          b.classList.remove('bg-primary', 'text-white', 'shadow-md', 'border-transparent', 'active');
          b.classList.add('bg-white', 'text-text', 'border-highlight', 'shadow-sm');
        });
        
        target.classList.remove('bg-white', 'text-text', 'border-highlight', 'shadow-sm');
        target.classList.add('bg-primary', 'text-white', 'shadow-md', 'border-transparent', 'active');

        // 2. ç¯©é¸å…§å®¹
        const filter = target.getAttribute('data-filter');
        let count = 0;

        items.forEach(item => {
          const el = item as HTMLElement;
          const category = el.getAttribute('data-category');
          
          if (filter === 'all' || category === filter) {
            el.style.display = 'block';
            el.animate([
              { opacity: 0, transform: 'translateY(10px)' },
              { opacity: 1, transform: 'translateY(0)' }
            ], { duration: 300, fill: 'forwards' });
            count++;
          } else {
            el.style.display = 'none';
          }
        });

        // 3. æŸ¥ç„¡è³‡æ–™
        if (noResults) {
          noResults.style.display = count === 0 ? 'block' : 'none';
        }
      });
    });
  });
</script>