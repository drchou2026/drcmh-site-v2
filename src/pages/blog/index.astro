---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/common/Header.astro';
import Footer from '../../components/common/Footer.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import { getCollection } from 'astro:content';

// 1. 從 Content Collection 獲取所有文章
// 注意：這裡使用 'blog' 是因為 src/content/config.ts 定義的名稱是 blog
const allPosts = await getCollection('blog');

// 2. 依照日期排序 (新 -> 舊)
const sortedPosts = allPosts.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// 3. 提取所有標籤 (用於篩選器)
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))];
---

<Layout 
  title="衛教專欄 | 周孟翰醫師"
  description="周孟翰醫師的泌尿科衛教專欄，提供攝護腺肥大、微創手術、性功能障礙等專業醫療知識。"
>
  
  <Header slot="header" />

  <!-- Page Header -->
  <section class="pt-32 pb-16 bg-bg relative overflow-hidden">
    {/* 裝飾背景 */}
    <div class="absolute top-0 right-0 w-1/3 h-full bg-highlight/30 -skew-x-12 translate-x-20 z-0 pointer-events-none"></div>
    
    <div class="container mx-auto px-6 relative z-10 text-center">
      <h1 class="text-4xl md:text-5xl font-serif font-bold text-primary mb-4">衛教專欄</h1>
      <p class="text-text max-w-2xl mx-auto leading-relaxed">
        正確的醫療知識，是健康的基石。<br/>
        這裡匯集了診間常見的疑問與最新的治療趨勢，希望能為您解惑。
      </p>
    </div>
  </section>

  <!-- Filter & Grid -->
  <section class="py-12 bg-surface min-h-screen">
    <div class="container mx-auto px-6">
      
      {/* 標籤篩選器 (Filter Bar) */}
      <div class="flex flex-wrap justify-center gap-3 mb-12" id="filter-container">
        <button 
          class="filter-btn active px-5 py-2 rounded-full text-sm font-bold transition-all border border-transparent bg-primary text-white shadow-md hover:shadow-lg hover:-translate-y-0.5"
          data-filter="all"
        >
          全部文章
        </button>
        {allTags.map(tag => (
          <button 
            class="filter-btn px-5 py-2 rounded-full text-sm font-bold transition-all border border-highlight bg-white text-text hover:border-accent hover:text-accent hover:-translate-y-0.5"
            data-filter={tag}
          >
            #{tag}
          </button>
        ))}
      </div>

      {/* 文章列表 */}
      {sortedPosts.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="posts-grid">
          {sortedPosts.map(post => (
            <BlogCard post={post} />
          ))}
        </div>
      ) : (
        <div class="text-center py-20 text-text/50">
          <p>目前還沒有發布任何文章，敬請期待。</p>
        </div>
      )}

      {/* 無搜尋結果提示 (預設隱藏) */}
      <div id="no-results" class="hidden text-center py-20">
        <p class="text-text/50 text-lg">沒有找到符合該標籤的文章。</p>
        <button 
          class="mt-4 text-accent font-bold hover:underline"
          onclick="document.querySelector('[data-filter=all]').click()"
        >
          清除篩選
        </button>
      </div>

    </div>
  </section>

  <Footer slot="footer" />

</Layout>

<script>
  // 客戶端篩選邏輯 (Client-side Filtering)
  const buttons = document.querySelectorAll('.filter-btn');
  const cards = document.querySelectorAll('.blog-card');
  const noResults = document.getElementById('no-results');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      // 1. 更新按鈕樣式 (Active State)
      buttons.forEach(b => {
        b.classList.remove('bg-primary', 'text-white', 'shadow-md');
        b.classList.add('bg-white', 'text-text', 'border-highlight');
      });
      btn.classList.remove('bg-white', 'text-text', 'border-highlight');
      btn.classList.add('bg-primary', 'text-white', 'shadow-md');

      // 2. 篩選文章
      const filter = btn.getAttribute('data-filter');
      let visibleCount = 0;

      cards.forEach(card => {
        const cardTags = (card.getAttribute('data-tags') || '').split(',');
        
        // 判斷是否顯示
        if (filter === 'all' || (filter && cardTags.includes(filter))) {
          const el = card as HTMLElement;
          el.style.display = 'flex';
          
          // 簡單的淡入動畫
          el.animate([
            { opacity: 0, transform: 'translateY(10px)' },
            { opacity: 1, transform: 'translateY(0)' }
          ], {
            duration: 300,
            easing: 'ease-out',
            fill: 'forwards'
          });
          
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      // 3. 處理無結果狀態
      if (noResults) {
        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
      }
    });
  });
</script>