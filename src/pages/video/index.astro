---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/common/Header.astro';
import Footer from '../../components/common/Footer.astro';
import { getCollection, getEntry } from 'astro:content';
import { Image } from 'astro:assets';

// 1. 取得兩種類型的影片
const videos = await getCollection('videos');
const shortsEntry = await getEntry('shorts', 'index');
const shortsList = shortsEntry?.data?.list || [];

// 2. 日期排序 (新到舊)
const sortedVideos = videos.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const sortedShorts = shortsList.sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());

// 輔助函式：取得 YouTube ID
function getYouTubeID(url: string) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
}

// 輔助函式：取得 YouTube Shorts ID
function getShortsID(url: string) {
  // 支援 https://www.youtube.com/shorts/VIDEO_ID
  const regExp = /shorts\/([a-zA-Z0-9_-]+)/;
  const match = url.match(regExp);
  if (match && match[1]) return match[1];

  // 或是普通網址
  return getYouTubeID(url);
}

function formatDate(date: Date) {
  return new Date(date).toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric' });
}
---

<Layout 
  title="影音專區 | Dr. Chou 泌尿科診所"
  description="透過影像深入淺出地了解泌尿科知識，或是看看醫師的日常花絮。"
>
  
  <Header slot="header" />

  {/* === 1. 大氣版頭 === */}
  <section class="py-16 bg-bg relative overflow-hidden">
    <div class="absolute top-0 right-0 w-1/3 h-full bg-highlight/30 -skew-x-12 translate-x-20 z-0 pointer-events-none"></div>
    <div class="container mx-auto px-6 relative z-10 text-center">
      <h1 class="text-4xl md:text-5xl font-serif font-bold text-primary mb-4">影音專區</h1>
      <p class="text-text max-w-2xl mx-auto leading-relaxed">
        影像紀錄，讓醫學更親近。<br/>
        這裡匯集了衛教解說與診間的溫馨日常。
      </p>
    </div>
  </section>

  {/* === 2. 影片列表區 (Tab 切換) === */}
  <section class="py-12 bg-surface min-h-screen">
    <div class="container mx-auto px-4 md:px-6">

      {/* Tab 按鈕 */}
      <div class="flex flex-wrap justify-center gap-4 mb-12">
        <button 
          id="tab-shorts"
          class="tab-btn active px-6 py-3 rounded-full text-sm font-bold transition-all border border-transparent bg-primary text-white shadow-md"
          data-target="content-shorts"
        >
          短影音
        </button>
        <button 
          id="tab-videos"
          class="tab-btn px-6 py-3 rounded-full text-sm font-bold transition-all border border-highlight bg-white text-text shadow-sm"
          data-target="content-videos"
        >
          衛教影片
        </button>
      </div>

      {/* === Tab 內容 2: 衛教影片 (橫式) === */}
      <div id="content-videos" class="tab-content grid gap-x-8 gap-y-12 md:grid-cols-2 lg:grid-cols-3 fade-in-up hidden">
        {sortedVideos.length === 0 ? (
           <div class="col-span-full text-center py-20 text-gray-400">
             <i class="fa-solid fa-video-slash text-4xl mb-4"></i>
             <p>目前尚無衛教影片，敬請期待。</p>
           </div>
        ) : sortedVideos.map((video) => {
          let ytId = getYouTubeID(video.data.youtubeUrl);
          let autoThumb = ytId ? `https://img.youtube.com/vi/${ytId}/maxresdefault.jpg` : null;

          return (
            <div class="video-card group block">
              {/* 縮圖與播放器 */}
              <div 
                class="yt-player-container relative aspect-video rounded-2xl overflow-hidden bg-gray-100 shadow-sm group-hover:shadow-xl transition-all duration-300 cursor-pointer"
                data-yt-id={ytId}
                data-type="landscape"
              >
                <div class="thumbnail-wrapper w-full h-full absolute inset-0">
                  {video.data.customThumbnail ? (
                     <Image 
                       src={video.data.customThumbnail} 
                       alt={video.data.title}
                       class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                       width={600}
                       height={338}
                     />
                  ) : autoThumb ? (
                     <img 
                       src={autoThumb} 
                       alt={video.data.title}
                       class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                     />
                  ) : (
                     <div class="w-full h-full flex items-center justify-center bg-gray-800 text-gray-500">
                       <i class="fa-solid fa-film text-4xl"></i>
                     </div>
                  )}
                  {/* 播放按鈕 */}
                  <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                    <div class="w-16 h-16 bg-white/90 backdrop-blur rounded-full flex items-center justify-center pl-1 shadow-lg group-hover:scale-110 transition-transform duration-300">
                      <i class="fa-solid fa-play text-2xl text-red-600"></i>
                    </div>
                  </div>
                </div>
                {/* 標籤 */}
                <div class="absolute top-3 left-3 pointer-events-none">
                  <span class="bg-black/60 backdrop-blur-md text-white text-xs font-bold px-3 py-1 rounded-full">
                    {video.data.category === 'education' ? '衛教' : 
                     video.data.category === 'vlog' ? '花絮' : '媒體'}
                  </span>
                </div>
              </div>

              {/* 文字資訊 */}
              <div class="mt-4 px-1">
                <div class="flex items-center gap-2 mb-2 text-xs text-gray-400 font-medium">
                   <i class="fa-regular fa-clock"></i>
                   <span>{formatDate(video.data.date)}</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 leading-snug line-clamp-2">
                  <a href={video.data.youtubeUrl} target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">
                    {video.data.title}
                  </a>
                </h3>
              </div>
            </div>
          );
        })}
      </div>

      {/* === Tab 內容 1: 短影音 (直式) === */}
      <div id="content-shorts" class="tab-content grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 fade-in-up">
        {sortedShorts.length === 0 ? (
           <div class="col-span-full text-center py-20 text-gray-400">
             <i class="fa-solid fa-mobile-screen text-4xl mb-4"></i>
             <p>目前尚無短影音，敬請期待。</p>
           </div>
        ) : sortedShorts.map((video) => {
          let ytId = getShortsID(video.youtubeUrl);
          // Shorts 的縮圖通常還是 maxresdefault，但有時需要 mqdefault。暫用 maxresdefault。
          let autoThumb = ytId ? `https://img.youtube.com/vi/${ytId}/maxresdefault.jpg` : null;

          return (
            <div class="video-card group block">
              {/* 縮圖與播放器 (直式 9:16) */}
              <div 
                class="yt-player-container relative aspect-[9/16] rounded-2xl overflow-hidden bg-gray-100 shadow-sm group-hover:shadow-xl transition-all duration-300 cursor-pointer border border-white/50"
                data-yt-id={ytId}
                data-type="portrait"
              >
                <div class="thumbnail-wrapper w-full h-full absolute inset-0">
                  {autoThumb ? (
                     <img 
                       src={autoThumb} 
                       alt={video.title}
                       class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                     />
                  ) : (
                     <div class="w-full h-full flex items-center justify-center bg-gray-800 text-gray-500">
                       <i class="fa-solid fa-film text-4xl"></i>
                     </div>
                  )}
                  {/* 播放按鈕 */}
                  <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                    <div class="w-12 h-12 bg-white/90 backdrop-blur rounded-full flex items-center justify-center pl-1 shadow-lg group-hover:scale-110 transition-transform duration-300">
                      <i class="fa-solid fa-play text-xl text-red-600"></i>
                    </div>
                  </div>
                </div>
              </div>

              {/* 文字資訊 */}
              <div class="mt-3 px-1">
                <h3 class="text-sm md:text-base font-bold text-gray-800 leading-snug line-clamp-2">
                  <a href={video.youtubeUrl} target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">
                    {video.title}
                  </a>
                </h3>
                 <div class="flex items-center gap-2 mt-1 text-[10px] md:text-xs text-gray-400 font-medium">
                   <i class="fa-regular fa-clock"></i>
                   <span>{formatDate(video.date)}</span>
                </div>
              </div>
            </div>
          );
        })}
      </div>

    </div>
  </section>

  <Footer slot="footer" />

</Layout>

<style>
  /* Tab 按鈕懸停效果 (比照部落格標籤) */
  .tab-btn:not(.active):hover {
    @apply border-accent text-accent -translate-y-0.5 shadow-lg;
  }
  
  /* 選中狀態 hover 時不顯示 accent 色，也不位移 */
  .tab-btn.active:hover {
    @apply transform-none text-white border-transparent cursor-default;
  }
</style>

<script>
  // 1. YouTube 點擊播放邏輯 (通用：橫式與直式)
  function initYouTubePlayers() {
    const containers = document.querySelectorAll('.yt-player-container:not([data-bound="true"])');
    
    containers.forEach(container => {
      container.setAttribute('data-bound', 'true');
      container.addEventListener('click', (e) => {
        e.stopPropagation();
        const id = container.getAttribute('data-yt-id');
        const type = container.getAttribute('data-type');
        if (!id) return;

        const origin = window.location.origin;
        // Shorts 與 一般影片其實都能用 embed/ID 播放，助於比例不同
        const src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&playsinline=1&origin=${origin}`;

        container.innerHTML = `
          <iframe 
            src="${src}" 
            title="YouTube video player" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
            allowfullscreen
            class="absolute inset-0 w-full h-full rounded-2xl"
          ></iframe>
        `;
      });
    });
  }

  // 2. Tab 切換邏輯
  function initTabs() {
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');

    if (!tabs.length) return;

    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        if (target.classList.contains('active')) return;

        // 1. 重置所有 Tab 樣式
        tabs.forEach(t => {
          t.classList.remove('bg-primary', 'text-white', 'shadow-md', 'active', 'border-transparent');
          t.classList.add('bg-white', 'text-text', 'border-highlight');
        });

        // 2. 啟用當前 Tab 樣式
        target.classList.remove('bg-white', 'text-text', 'border-highlight');
        target.classList.add('bg-primary', 'text-white', 'shadow-md', 'active', 'border-transparent');

        // 3. 切換內容顯示
        const targetId = target.getAttribute('data-target');
        contents.forEach(content => {
          if (content.id === targetId) {
            content.classList.remove('hidden');
            // 觸發簡單的淡入動畫
            content.animate([
              { opacity: 0, transform: 'translateY(10px)' },
              { opacity: 1, transform: 'translateY(0)' }
            ], { duration: 300, fill: 'forwards' });
          } else {
            content.classList.add('hidden');
          }
        });
      });
    });
  }

  document.addEventListener('astro:page-load', () => {
    initYouTubePlayers();
    initTabs();
  });
</script>
