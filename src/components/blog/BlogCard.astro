---
import { Calendar, Tag, ArrowRight } from 'lucide-react';
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'blog'>; 
}

const { post } = Astro.props;

// ğŸŸ¢ 1. ä¿®å¾©é€£çµï¼šè™•ç† Astro v5 glob loader çš„ ID
const slug = post.id.replace(/\.(mdoc|md|yaml|json)$/, '');

// ğŸŸ¢ 2. æ–°å¢ï¼šä¸€å€‹ç°¡å–®çš„å‡½å¼ä¾†æ¸…é™¤ Markdown ç¬¦è™Ÿ (è½‰æˆç´”æ–‡å­—)
function stripMarkdown(markdown: string | undefined) {
  if (!markdown) return '';
  return markdown
    .replace(/^#+\s+/gm, '')       // ç§»é™¤æ¨™é¡Œ (## Title)
    .replace(/!\[.*?\]\(.*?\)/g, '') // ç§»é™¤åœ–ç‰‡ (![alt](url))
    .replace(/\[(.*?)\]\(.*?\)/g, '$1') // ç§»é™¤é€£çµä½†ä¿ç•™æ–‡å­— ([text](url))
    .replace(/(\*\*|__)(.*?)\1/g, '$2') // ç§»é™¤ç²—é«” (**text**)
    .replace(/(\*|_)(.*?)\1/g, '$2')    // ç§»é™¤æ–œé«” (*text*)
    .replace(/^>\s+/gm, '')        // ç§»é™¤å¼•ç”¨ (> text)
    .replace(/`{1,3}.*?`{1,3}/g, '') // ç§»é™¤ç¨‹å¼ç¢¼å€å¡Š
    .replace(/\n/g, ' ')           // æŠŠæ›è¡Œè®Šæˆç©ºç™½
    .trim();
}

// ğŸŸ¢ 3. é‚è¼¯å‡ç´šï¼š
// å„ªå…ˆé †åºï¼šæ‰‹å‹•æ‘˜è¦ > SEO æè¿° > è‡ªå‹•æŠ“å‰ 60 å­— > é è¨­æ–‡å­—
const advancedData = post.data.advanced?.discriminant ? post.data.advanced.value : null;

// è‡ªå‹•ç”¢ç”Ÿæ‘˜è¦ (å¾ body æŠ“å–ï¼Œå¦‚æœ body æ˜¯ç©ºçš„å°±çµ¦ç©ºå­—ä¸²)
const autoExcerpt = stripMarkdown(post.body).substring(0, 50) + (post.body && post.body.length > 60 ? '...' : '');

const excerpt = advancedData?.excerpt || advancedData?.seoDescription || autoExcerpt || 'é»æ“Šé–±è®€å…¨æ–‡...';
// æ ¼å¼åŒ–æ—¥æœŸ
const formattedDate = post.data.date.toISOString().split('T')[0].replace(/-/g, '.');
---

<article 
  class="group flex flex-col h-full bg-surface rounded-2xl overflow-hidden border border-transparent hover:border-accent/20 hover:shadow-xl transition-all duration-300 cursor-pointer"
>
  <a href={`/blog/${slug}`} class="flex flex-col h-full">
    
    {/* å°é¢åœ–å€åŸŸ (å›ºå®šæ¯”ä¾‹ 16:9) */}
    <div class="relative aspect-video overflow-hidden bg-gray-200">
      {post.data.coverImage ? (
        <Image 
          src={post.data.coverImage} 
          alt={post.data.title}
          class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
        />
      ) : (
        // ğŸŸ¢ 3. ç„¡åœ–æ™‚çš„å„ªåŒ–ï¼šä½¿ç”¨æ¼¸å±¤æ¨™é¡Œå­—å¡ (å–ä»£åŸæœ¬å–®èª¿çš„ icon)
        <div class="w-full h-full flex items-center justify-center p-6 bg-gradient-to-br from-primary/5 via-bg to-accent/10 group-hover:from-primary/10 group-hover:to-accent/20 transition-colors">
           <h3 class="text-xl font-serif font-bold text-primary/80 text-center leading-tight line-clamp-3 group-hover:text-primary">
             {post.data.title}
           </h3>
        </div>
      )}
      
      {/* ç¬¬ä¸€å€‹æ¨™ç±¤ (Badge) - é¡¯ç¤ºåœ¨åœ–ç‰‡å³ä¸Šè§’ */}
      {post.data.tags && post.data.tags.length > 0 && (
        <span class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 text-xs font-bold text-primary rounded-full shadow-sm z-10 border border-gray-100">
          {post.data.tags[0]}
        </span>
      )}
    </div>

    {/* å…§å®¹å€åŸŸ */}
    <div class="p-6 flex flex-col flex-grow">
      
      {/* Meta è³‡è¨Š (æ—¥æœŸ + ç¬¬äºŒå€‹æ¨™ç±¤) */}
      <div class="flex items-center gap-3 mb-3 text-xs text-text/60">
        <div class="flex items-center gap-1">
          <Calendar size={12} />
          <span>{formattedDate}</span>
        </div>
        
        {/* å¦‚æœæœ‰ç¬¬äºŒå€‹æ¨™ç±¤ï¼Œé¡¯ç¤ºåœ¨é€™è£¡ */}
        {post.data.tags && post.data.tags.length > 1 && (
          <>
            <span class="w-1 h-1 rounded-full bg-accent"></span>
            <div class="flex items-center gap-1">
              <Tag size={12} />
              <span class="truncate max-w-[80px]">{post.data.tags[1]}</span>
            </div>
          </>
        )}
      </div>

      {/* æ¨™é¡Œ */}
      <h3 class="text-xl font-serif font-bold text-primary mb-3 leading-snug line-clamp-2 group-hover:text-accent transition-colors">
        {post.data.title}
      </h3>

      {/* æ‘˜è¦ */}
      <p class="text-sm text-text/80 leading-relaxed line-clamp-3 mb-6 flex-grow">
        {excerpt}
      </p>

      {/* åº•éƒ¨æŒ‰éˆ•å€ (Read More + Arrow) */}
      <div class="pt-4 border-t border-primary/5 flex items-center justify-between mt-auto">
        <span class="text-sm font-bold text-primary group-hover:text-accent transition-colors">é–±è®€å…¨æ–‡</span>
        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-primary shadow-sm border border-gray-100 group-hover:bg-accent group-hover:text-white group-hover:border-accent transition-all duration-300 transform group-hover:translate-x-1">
          <ArrowRight size={14} />
        </div>
      </div>

    </div>
  </a>
</article>